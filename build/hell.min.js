class Area{constructor(e,t,s,i,o){this.x=Math.round(e),this.y=Math.round(t),this.w=Math.max(Math.round(s),1),this.h=Math.max(Math.round(i),1),this.c=o}isInside(e,t){return e>=this.x&&e<this.x+this.w&&t>=this.y&&t<this.y+this.h}}class Node extends Area{constructor(e,t,s,i){super(e,t,s,i,Math.floor(random(255))),this.paths=[],this.walls=[]}split(e){if(this.a||this.b)return!1;const t=Math.random()>this.w/(this.w+this.h);if(e>(t?this.h:this.w))return!1;const s=(t?this.h:this.w)-e;if(e>s)return!1;const i=Math.floor(random(e,s));return t?(this.a=new Node(this.x,this.y,this.w,i),this.b=new Node(this.x,this.y+i,this.w,this.h-i)):(this.a=new Node(this.x,this.y,i,this.h),this.b=new Node(this.x+i,this.y,this.w-i,this.h)),!0}createRooms(){if(this.a||this.b)this.a&&this.a.createRooms(),this.b&&this.b.createRooms(),this.a&&this.b&&this.createPath(this.a.getRoom(),this.b.getRoom());else{const e=Math.floor(random(3,this.w-2)),t=Math.floor(random(3,this.h-2)),s=Math.floor(random(1,this.w-e-1)),i=Math.floor(random(1,this.h-t-1));this.room=new Room(s+this.x,i+this.y,e,t,"plum")}}createWalls(){if(this.paths.length){let e=[];this.a&&(e=e.concat(this.a.getRooms())),this.b&&(e=e.concat(this.b.getRooms()));for(let t=this.x;t<this.x+this.w;t++)for(let s=this.y;s<this.y+this.h;s++){let i=!1;for(let o=0;o<e.length;o++)e[o].isInside(t,s)&&(i=!0);for(let e=0;e<this.paths.length;e++)this.paths[e].isInside(t,s)&&(i=!0);i||this.walls.push(new Wall(t,s))}}else this.a&&this.a.createWalls(),this.b&&this.b.createWalls()}getRooms(){if(this.room)return[this.room];{let e,t;return this.a&&(e=this.a.getRooms()),this.b&&(t=this.b.getRooms()),e||t?e?t?e.concat(t):[t]:[e]:null}}getRoom(){if(this.room)return this.room;{let e,t;return this.a&&(e=this.a.getRoom()),this.b&&(t=this.b.getRoom()),e||t?t?e&&random(1)>.5?e:t:e:null}}createPath(e,t){let s={x:Math.floor(random(e.x+1,e.x+e.w-2)),y:Math.floor(random(e.y+1,e.y+e.h-2))},i={x:Math.floor(random(t.x+1,t.x+t.w-2)),y:Math.floor(random(t.y+1,t.y+t.h-2))},o=i.x-s.x,l=i.y-s.y;o<0?l<0?random(1)>.5?(this.paths.push(new Path(i.x,s.y,Math.abs(o)+1,1,"gold")),this.paths.push(new Path(i.x,i.y,1,Math.abs(l)+1,"gold"))):(this.paths.push(new Path(i.x,i.y,Math.abs(o)+1,1,"gold")),this.paths.push(new Path(s.x,i.y,1,Math.abs(l)+1,"gold"))):l>0?random(1)>.5?(this.paths.push(new Path(i.x,s.y,Math.abs(o)+1,1,"gold")),this.paths.push(new Path(i.x,s.y,1,Math.abs(l)+1,"gold"))):(this.paths.push(new Path(i.x,i.y,Math.abs(o)+1,1,"gold")),this.paths.push(new Path(s.x,s.y,1,Math.abs(l),"gold"))):this.paths.push(new Path(i.x,i.y,Math.abs(o)+1,1,"gold")):o>0?l<0?random(1)>.5?(this.paths.push(new Path(s.x,i.y,Math.abs(o)+1,1,"gold")),this.paths.push(new Path(s.x,i.y,1,Math.abs(l)+1,"gold"))):(this.paths.push(new Path(s.x,s.y,Math.abs(o)+1,1,"gold")),this.paths.push(new Path(i.x,i.y,1,Math.abs(l)+1,"gold"))):l>0?random(1)>.5?(this.paths.push(new Path(s.x,s.y,Math.abs(o)+1,1,"gold")),this.paths.push(new Path(i.x,s.y,1,Math.abs(l)+1,"gold"))):(this.paths.push(new Path(s.x,i.y,Math.abs(o)+1,1,"gold")),this.paths.push(new Path(s.x,s.y,1,Math.abs(l)+1,"gold"))):this.paths.push(new Path(s.x,s.y,Math.abs(o)+1,1,"gold")):l<0?this.paths.push(new Path(i.x,i.y,1,Math.abs(l)+1,"gold")):this.paths.push(new Path(s.x,s.y,1,Math.abs(l)+1,"gold"))}display(){"undefined"!=typeof p5&&(textSize(14),fill("blue"),textAlign(LEFT,TOP),text(`${this.x},${this.y}`,this.x*cellSize.w,this.y*cellSize.h)),this.room&&this.room.display(),this.a&&this.a.display(),this.b&&this.b.display();for(let e=0;e<this.paths.length;e++)this.paths[e].display();for(let e=0;e<this.walls.length;e++)this.walls[e].display()}}class BSPMap{constructor(e,t,s,i){this.cols=e,this.rows=t,this.minNodeSize=s,this.maxNodeSize=i,this.nodes=[],this.walls=[]}updateSize(e,t,s,i){this.cols=e,this.rows=t,this.minNodeSize=s,this.maxNodeSize=i}build(e,t){this.walls=[],this.nodes=[],this.nodes.push(new Node(e.w,e.h,this.cols-2*e.w,this.rows-2*e.h)),console.groupCollapsed("load map"),console.time("nodes");let s=!0;for(;s&&this.nodes.length<t;){s=!1;for(let e=0,i=this.nodes.length;e<i;e++){const i=this.nodes[e];!i.a&&!i.b&&this.nodes.length<t-1&&(i.w>this.maxNodeSize||i.h>this.maxNodeSize)&&i.split(this.minNodeSize)&&(this.nodes.push(i.a),this.nodes.push(i.b),s=!0)}}console.timeEnd("nodes"),console.time("rooms"),this.nodes[0].createRooms(),console.timeEnd("rooms"),console.time("walls");for(let e=0;e<this.cols;e++)for(let t=0;t<this.rows;t++){let s=!1;for(let i=0;i<this.nodes.length;i++){this.nodes[i].room&&this.nodes[i].room.isInside(e,t)&&(s=!0);for(let o=0;o<this.nodes[i].paths.length;o++)this.nodes[i].paths[o].isInside(e,t)&&(s=!0)}s||this.walls.push(new Wall(e*cellSize.w,t*cellSize.h,"green"))}console.timeEnd("walls"),console.groupEnd()}}class Room extends Area{constructor(...e){super(...e),this.texture=new Texture({frame:"randomIndex",center:!0},!1),this.addTextureAnimation();let t=[];for(let e=gme.lvl,s=gme.lvl+Cool.random(5,10);e<s;e++){const i=1-(e-gme.lvl)/s;for(let s=0;s<Math.floor(10*i);s++)t.push(e)}for(let e=this.x;e<this.x+this.w;e++)for(let s=this.y;s<this.y+this.h;s++)this.texture.addLocation(e*cellSize.w,s*cellSize.h,Cool.random(t));this.debug=!0,this.takenCells=[]}addTextureAnimation(){this.texture.animation=gme.anims.textures.dirt}getCell(e){const t=[];for(let e=this.x;e<this.x+this.w;e++)for(let s=this.y;s<this.y+this.h;s++)this.takenCells.some(t=>t.x==e&&t.y==s)||t.push({x:e,y:s});const s=Cool.random(t);return s&&this.takenCells.push({...s,label:e}),s}display(){this.texture.display(),this.debug&&mapAlpha>0&&(gme.ctx.globalAlpha=mapAlpha/2,gme.ctx.fillStyle=this.c,gme.ctx.fillRect(this.x*mapCellSize,this.y*mapCellSize,this.w*mapCellSize,this.h*mapCellSize),gme.ctx.fillStyle="white",gme.ctx.font=mapCellSize/2+"px sans-serif",gme.ctx.fillText(`${this.x},${this.y}`,this.x*mapCellSize,this.y*mapCellSize+10),gme.ctx.globalAlpha=1)}update(e){this.texture.update(e)}}class HellItem extends ColliderEntity{constructor(e,t,s,i,o){super({x:e,y:t}),this.addAnimation(s);for(const e in i)this[e]=i[e]||0;this.action&&(this.actionString=`${this.action}${this.dt?" "+this.dt:""} ${this.label}`),"food"==o&&(this.c="red"),"scripture"==o&&(this.c="lightblue"),"animal"==o&&(this.c="green"),"special"==o&&(this.c="yellow")}}class MapItem extends HellItem{constructor(...e){super(...e),this.isColliding=!1,this.xKey=()=>{map.remove(this),player.action(this)}}display(){super.display(),mapAlpha>0&&(gme.ctx.globalAlpha=mapAlpha,gme.ctx.fillStyle=this.c,gme.ctx.fillRect(this.origin.x/cellSize.w*mapCellSize,this.origin.y/cellSize.h*mapCellSize,8,8),gme.ctx.globalAlpha=1)}update(e){super.update(e),!this.collide(player)||this.isColliding||player.isColliding?!this.collide(player)&&this.isColliding&&(ui.console.setMsg(""),this.isColliding=!1,player.isColliding=!1,ui.console.xKey=void 0):(ui.console.setMsg("Press X to "+this.actionString),this.isColliding=!0,player.isColliding=!0,ui.console.xKey=()=>{this.isColliding=!1,player.isColliding=!1,this.xKey()})}}class HellGame extends Game{constructor(...e){super(...e),this.lvl=0}set scene(e){e!=this.scenes._current&&(this.scenes.current=e),ui.console.isActive="message"!=e}get currentScene(){return this.scenes.current}get currentSceneName(){return this.scenes._current}get lvlName(){return 0==this.lvl?"Purgatory":"Ring of Hell "+this.lvl}}class HellGate extends MapItem{constructor(...e){super(...e),this.c="orange",this.actionString="Enter Judgement's Gate",this.xKey=()=>{player.enterGate()}}}class HellMap extends BSPMap{constructor(e){const t={w:Math.ceil(gme.view.halfWidth/cellSize.w),h:Math.ceil(gme.view.halfHeight/cellSize.h)};super(e+2*t.w,e+2*t.h,e/4,e/2-1),this.size=12,this.buffer=t,gme.scenes.map.add(this),this.items=new SpriteCollection}build(e){console.time("map");let t=this.size+gme.lvl;this.updateSize(t+2*this.buffer.w,t+2*this.buffer.h,t/4,t/2-1),super.build(this.buffer,6+gme.lvl),this.roomCount=this.nodes.filter(e=>e.room).length,this.cellCount=this.nodes.filter(e=>e.room).map(e=>e.room.w*e.room.h).reduce((e,t)=>e+t);const s=["#F8F8F8","#E8E8E8","#D8D8D8","#C8C8C8","#B8B8B8","#A8A8A8","#989898","#888888","#787878","#686868","#585858","#484848","#383838","#282828","#181818","#080808"],i=s[Math.min(gme.lvl,s.length-1).clamp(0,s.length-1)];this.walls.forEach(e=>{e.texture.animation.over={c:i}}),this.nodes.forEach(e=>{e.room&&(e.room.texture.animation.over={c:i}),e.paths&&e.paths.forEach(e=>{e.texture.animation.over={c:i}})}),console.log("wall color",i),e&&e()}addAllMapItems(){this.items.clear();const e=this.nodes.filter(e=>e.room),t=shuffle(e.filter(e=>!e.room.takenCells.some(e=>"player"==e.label)));let s;for(let e=0;e<t.length&&(s=t[e].room.getCell("hells_gate"),!s);e++);if(!s)for(let e=0;e<t.length&&(s=t[e].room.getCell("hells_gate"),!s);e++);s||console.log(t,e);const i=new HellGate(s.x*cellSize.w+Cool.random(-cellSize.w/4,cellSize.w/4),s.y*cellSize.h+Cool.random(-cellSize.h/4,cellSize.h/4),gme.anims.sprites.hells_gate,["fart",0,0,0,0,0,0,0,0],"gate");this.items.add(i),this.cellCount-=2,this.addItems("sinner",Sinner,1),this.addItems("food",MapItem),gme.lvl>0&&this.addItems("scripture",MapItem,Cool.random([0,1,1,2,2,3])),gme.lvl>2&&this.addItems("animal",MapItem,Cool.random([0,1,1,2])),gme.lvl>4&&this.addItems("special",MapItem,Cool.random([0,0,1]))}prob(e){return e=e.replace(/p(?![a-z])/g,Cool.map(gme.lvl,0,28,0,1)),Function("return "+e)().clamp(0,1)}addItems(e,t,s){const i=s||random(1,this.roomCount),o=gme.data.items.entries.filter(t=>t.type==e),l=[],a=[];for(let e=0;e<o.length;e++){const t=this.prob(o[e].probability);if(1==t)a.push(e);else if(t>0)for(let s=0;s<100*t;s++)l.push(e)}for(;a.length<i;)a.push(Cool.random(l.filter(e=>!a.includes(e))));for(;a.length>0&&this.cellCount>0;){const i=o[a.pop()],l=shuffle(this.nodes.filter(e=>e.room));for(let o=0;o<l.length;o++){const a=l[o].room.getCell(e);if(a){i||console.log(e,s,this.cellCount);const o=new t(a.x*cellSize.w+Cool.random(-cellSize.w/4,cellSize.w/4),a.y*cellSize.h+Cool.random(-cellSize.h/4,cellSize.h/4),gme.anims.items[i.label],i,e);o.animation.playStateCheck(),this.items.add(o),this.cellCount--;break}}}}add(e){this.items.add(e)}remove(e){this.items.remove(e)}display(){this.nodes[0].display();for(let e=0;e<this.walls.length;e++)this.walls[e].display();this.items.display()}update(){const e=new Cool.Vector(-player.mapPosition.x+gme.width/2,-player.mapPosition.y+gme.height/2);for(let t=0;t<this.nodes.length;t++){const s=this.nodes[t];s.room&&s.room.update(e);for(let t=0;t<s.paths.length;t++)s.paths[t].update(e)}for(let t=0;t<this.walls.length;t++)this.walls[t].update(e);let t=!1;for(let e=0;e<map.walls.length;e++){map.walls[e].collide(player)&&(t=!0)}t&&player.back(),this.items.all(t=>{t.update(e)})}}class HellMessage extends Text{constructor(e,t,s,i,o){super(e,t,s,i,o),gme.scenes.addToDisplay(this,["message","instructions"]),this.list=[],this.continue=new Text(this.x,this.y,"",100,gme.anims.lettering.messages)}next(){0==this.list.length?(this.set(""),player.died?loadNextMap():gme.scene="map"):this.set(this.list.shift())}add(e){let t=!1,s=4*this.wrap,i=0;for(let o=0;o<e.length;o++)o==i+s||t?e[o].match(/[\n\r\s]/g)?(this.list.push(e.substring(i,o)),t=!1,i=o+1):t=!0:i+s>e.length&&(this.list.push(e.substring(i,e.length)),o=e.length);this.msg||this.set(this.list.shift())}set(e){if(super.setMsg(e),e){const t=e.match(/[\n\r]/g),s=this.y+35*(this.breaks.length+2+(t?t.length:0));this.continue.setPosition(this.x,s),this.continue.setMsg("Press X to continue"),ui.console.xKey=()=>{player.playSFX("continue"),this.next()}}}display(){super.display(),this.continue.display()}reset(){this.set("")}}class Path extends Room{addTextureAnimation(){this.texture.animation=gme.anims.textures.grass}}class Player extends ColliderSprite{constructor(e,t,s,i){super(Math.round(t),Math.round(s)),this.mapPosition=new Cool.Vector(Math.round(t),Math.round(s)),this.prevPosition=this.mapPosition.clone(),this.center=!0,this.debug=i||!1,this.speed=new Cool.Vector(8,8),this.addAnimation(e),this.animation.state="idle",this.setCollider(25,6,78,90),this.input={right:!1,up:!1,left:!1,down:!1},this.metricCount=0,this.metricCheck=24,this.died=!1,this.health=100,this.hunger=0,this.hungerRate=1,this.hungerInterval=300,this.lastSpeedChange=this.hungerInterval,this.soundEnabled=!1,this.stepCount=0,this.stepInterval=32-2*this.speed.x,this.morality={gluttony:0,sloth:0,lust:0,pride:0,greed:0,envy:0,wrath:0,adjust:0},this.world={gluttony:0,sloth:0,lust:0,pride:0,greed:0,envy:0,wrath:0}}setSpeed(e){this.speed.x=+e,this.speed.y=+e,this.stepInterval=32-2*this.speed.x,this.sfxPlayer&&sound.setBPM(player.speed.x)}getSpeed(){return this.speed.x}get moralityScore(){return Object.values(this.morality).reduce((e,t)=>e+t)}inputKey(e,t){this.input[e]=t}update(e){this.prevPosition=this.mapPosition.clone();let t=this.animation.stateName.includes("idle")?this.animation.stateName:Cool.random(["idle"]),s="map"==gme.currentSceneName;const i=new Cool.Vector;if(this.input.up&&(this.mapPosition.y>gme.bounds.top&&s&&(i.y=-this.speed.y,(this.input.left||this.input.right)&&(i.y*=.71),this.hunger+=this.hungerRate),t="right"),this.input.down&&(this.mapPosition.y<gme.bounds.bottom&&s&&(i.y=this.speed.y,(this.input.left||this.input.right)&&(i.y*=.71),this.hunger+=this.hungerRate),t="left"),this.input.right&&(this.mapPosition.x<gme.bounds.right&&s&&(i.x=this.speed.x,(this.input.left||this.input.right)&&(i.x*=.71),this.hunger+=this.hungerRate),t="right"),this.input.left&&(this.mapPosition.x>gme.bounds.left&&s&&(i.x=-this.speed.x,(this.input.left||this.input.right)&&(i.x*=.71),this.hunger+=this.hungerRate),t="left"),this.mapPosition.add(i.multiply(e)),this.animation.state=t,!this.died&&s&&(this.metricCount==this.metricCheck&&(this.checkHunger(),this.metricCount=0),this.metricCount++),this.stepCount++,"idle"!=t&&this.soundEnabled&&this.stepCount>this.stepInterval){const e=Cool.randomInt(gme.lvl+10).clamp(0,this.stepSamples.length-1);this.sfxPlayer.player(this.stepSamples[e]).start(),this.stepCount=0}}back(){this.mapPosition=this.prevPosition.clone()}spawn(){const e=shuffle(map.nodes.filter(e=>e.room));let t;for(let s=0;s<e.length&&(t=e[s].room.getCell("player"),!t);s++);this.mapPosition.x=t.x*cellSize.w,this.mapPosition.y=t.y*cellSize.h}reborn(){this.hunger=0,this.hungerLevel=0,ui.metrics.level.update(),this.died=!1,this.setSpeed(8)}checkMorality(){0==this.moralityScore?(ui.message.add("You hath been morally neutral"),ui.message.add("You will remain in "+(0==gme.lvl?"purgatory":"this ring of hell"))):this.moralityScore>0?gme.lvl<=0?(gme.lvl,gme.scene="win",ui.message.continue.setMsg("Play again"),ui.message.next=loadNextMap):(gme.lvl-=1,ui.message.add("You hath acted morally")):(ui.message.add("You are a sinner"),ui.message.add("You descend further into hell"),gme.lvl+=1),ui.metrics.morality.update()}checkHunger(){let e="";this.hunger>this.lastSpeedChange&&(this.lastSpeedChange+=this.hungerInterval,this.speed.x>1&&this.setSpeed(this.speed.x-1));let t=Math.floor(this.hunger/this.hungerInterval);1==t?e="You feel a pang of hunger":2==t?e="Was that sound your stomach?":3==t?e="Your stomach growled":4==t?e="Your stomach is twisting in pain":5==t?e="You feel weak":6==t?e="You feel light headed":7==t?e="Your body is desparate for food":8==t&&(this.playSFX("died"),gme.scene="message",ui.message.set("You starved to death"),this.died=!0,this.checkMorality()),this.died||!e||this.isColliding||ui.console.setMsg(e)}enterGate(){this.playSFX("gate"),gme.scene="message",this.died=!0,this.checkMorality()}fight(e){this.playSFX("fight");let t=0;for(const s in this.world){const i=this.morality[s]+this.world[s];console.log(s,i,this.morality[s],this.world[s]);const o=i+e[s];console.log(o),o>0?t++:o<0&&t--}return gme.scene="message",0==t?ui.message.set(`You and ${e.fightString} are equals in sin.`):t<0?ui.message.set("You were defated by the sin of "+e.fightString):t>0&&ui.message.set(`You defeated ${e.fightString} with righteousness.`),player.morality.adjust+=t,ui.metrics.morality.update(),t}action(e){this.playSFX(e.action),gme.scene="message",ui.message.set("You "+e.actionString),ui.message.add(e.source),"food"==e.type&&(this.hunger=0,ui.message.add("Your hunger hath abated"),this.checkHunger(),this.setSpeed(8));for(const t in this.world)if(0!=+e[t])if("food"==e.type){let s=+e[t]+this.world[t];this.morality[t]+=s,ui.message.add(s<0?"You hath sinned":"You hath acted morally")}else"scripture"!=e.type&&"animal"!=e.type||(this.world[t]+=+e[t],ui.message.add(+e[t]<0?`Your knowledge of ${t} is clouded`:"You are learned of "+t));if(e.special){let t=e.special.split("&");for(let e=0;e<t.length;e++){let[s,i]=t[e].split("/");i.includes("m-")?(i=i.split("-")[1],this.morality[i]+=+s):"speed"==i?this.setSpeed(this.speed.x+ +s):this[i]+=+s,"adjust"==i&&(i="moral feeling"),ui.message.add(`You gained ${s} of ${i}`)}}ui.metrics.morality.update()}display(){super.display(),mapAlpha>0&&(gme.ctx.globalAlpha=mapAlpha,gme.ctx.fillStyle="blue",gme.ctx.fillRect(this.mapPosition.x/cellSize.w*mapCellSize,this.mapPosition.y/cellSize.h*mapCellSize,8,8),gme.ctx.globalAlpha=1)}playSFX(e){if(this.soundEnabled){this.sfxSamples.hasOwnProperty(e)||(e="special");let t=Cool.random(this.sfxSamples[e]);this.sfxPlayer.player(t).start()}}soundSetup(){sound.setBPM(player.speed.x);const e={},t={continue:2,dead:2,eat:2,fight:1,gate:6,read:6,sacrifice:3,special:2};this.sfxSamples={};for(const s in t){this.sfxSamples[s]=[];for(let i=1;i<=t[s];i++)e[`${s}-${i}`]=`sfx/${s}-${i}.mp3`,this.sfxSamples[s].push(`${s}-${i}`)}this.stepSamples=[];const s={step:10,stones:6,mud:6,splash:3};for(const t in s)for(let i=1;i<=s[t];i++)e[`${t}-${i}`]=`footsteps/${t}-${i}.mp3`,this.stepSamples.push(`${t}-${i}`);this.sfxPlayer=new Tone.Players({volume:-6}).toDestination(),console.time("load sfx");let i=new Tone.ToneAudioBuffers({urls:e,baseUrl:"./audio/",onload:()=>{console.timeEnd("load sfx");for(let t in e)this.sfxPlayer.add(t,i.get(t));this.soundEnabled=!0}})}}class Sinner extends MapItem{constructor(...e){super(...e),this.c="purple",this.fightString=`${this.dt?" "+this.dt:""} ${this.label}`,this.xKey=()=>{player.fight(this)>0&&map.remove(this)}}get moralityScore(){let e=0;for(const t in player.world)e+=this[t];return e}}class UIMetric extends Text{constructor(e,t,s){const i=s();super(e,t,i,i.length,gme.anims.lettering.metrics),this.callback=s,ui.addToDisplay(this)}update(){super.setMsg(this.callback()),this.wrap=this.msg.length,this.setBreaks()}}class Wall extends ColliderSprite{constructor(e,t,s){super(e*cellSize.w,t*cellSize.h),this.setCollider(e*cellSize.w,t*cellSize.h,cellSize.w,cellSize.h),this.center=!0,this.debug=!0,this.origin=[e,t],this.texture=new Texture({frame:"index",center:!0,animation:gme.anims.textures.walls},!1);let i=[];for(let e=Math.floor(gme.lvl/2),t=gme.lvl+Cool.random(5,10);e<t;e++){const s=1-(e-gme.lvl)/t;for(let t=0;t<Math.floor(10*s);t++)i.push(e)}for(let s=0,o=Cool.random([1,2,2,2,3,3,4]);s<o;s++)this.texture.addLocation(e+Math.floor(Cool.random(-cellSize.w/3,cellSize.w/3)),t+Math.floor(Cool.random(-cellSize.h/3,cellSize.h/3)),Cool.random(i))}display(){super.display(),this.texture.display()}update(e){this.position[0]=this.origin[0]+e.x,this.position[1]=this.origin[1]+e.y,this.texture.update(e)}}window.random=Cool.random;const gme=new HellGame({dps:24,width:960,height:720,zoom:1.25,multiColor:!0,checkRetina:!0,scenes:["music","instructions","map","message","loading","win"],events:["keyboard"]}),title=document.getElementById("title");function loadingAnimation(){let e="~"+title.textContent+"~";title.textContent=e}let loadingInterval,sound,player,god;if(window.parent!==window){console.log("iframe detected"),title.style.display="none";const e=document.createElement("button");e.textContent="start infinite hell",document.getElementById("splash").appendChild(e),e.onclick=function(){e.remove(),title.style.display="block",loadingInterval=setInterval(loadingAnimation,1e3/12),andLoad()}}else loadingInterval=setInterval(loadingAnimation,1e3/12),andLoad();function shuffle(e){let t,s,i=e.length;for(;0!==i;)s=Math.floor(Math.random()*i),i-=1,t=e[i],e[i]=e[s],e[s]=t;return e}function andLoad(){gme.load({ui:"data/ui.json",sprites:"data/sprites.json",textures:"data/textures.json",items:"data/items.csv",lettering:"data/lettering.json"})}let map,ui,cellSize={w:256,h:256},grafWrap=28,leftAlign=6,centerAlign=18*grafWrap,packY=260;const welcomeMessage=`You are in ${gme.lvlName}. \nYou are morally neutral. \n\nYou must perform a moral act to find your way to Heaven. \n\nIf you sin, you will descend further into Hell.`;let mapAlpha=0,mapCellSize=20;function startMusic(e){gme.scene="instructions",e&&(sound=new Sound,player.soundSetup()),ui.console.xKey=function(){player.playSFX("gate"),loadNextMap()},ui.console.zKey=void 0,ui.console.setMsg("Press X to begin")}function loadNextMap(){gme.scene="loading",ui.message.set(`Building ${gme.lvlName} ...`),setTimeout(buildMap,250)}function buildMap(){map.build((function(){ui.message.set(""),gme.scene="map",console.timeEnd("map"),player.died&&player.reborn(),player.spawn(),map.addAllMapItems(),gme.setBounds("top",gme.view.halfHeight),gme.setBounds("left",gme.view.halfWidth),gme.setBounds("right",map.cols*cellSize.w-gme.view.halfWidth),gme.setBounds("bottom",map.rows*cellSize.h-gme.view.halfHeight)}))}function Sound(){var e=["C_1","C#_1","D_1","D#_1","E_1","F_1","F#_1","G_1","G#_1","A_1","A#_1","B_1","C0","C#0","D0","D#0","E0","F0","F#0","G0","G#0","A0","A#0","B0","C1","C#1","D1","D#1","E1","F1","F#1","G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5","C6","C#6","D6","D#6","E6","F6","F#6","G6","G#6","A6","A#6","B6","C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7","C8","C#8","D8","D#8","E8","F8","F#8","G8","G#8","A8","A#8","B8","C9","C#9","D9","D#9","E9","F9","F#9","G9"];const t=[0,2,4,5,7,9,11];let s=54,i=[0,-3,-5,2,4,7,9,12,0,14,12,14];function o(e){return Cool.random(1)<e}document.addEventListener("keydown",e=>{"Digit1"==e.code&&P(),"Digit2"==e.code&&A()});let l,a=[],n=[],h=0,r=0,d={min:1,max:1},m={min:0,max:0},c=[1],u=[1],p=[1,4,8],g=[1],y=[.5,2,4,.25],f=[0,"1n","2n","4n","8n","1m","2m"],x=["3m","4m"],w={min:0,max:0},C=.25,S=.75,b=-.2,M=.2,v=[4,5],z=shuffle([2,3,6,7]);function A(){s>17&&gme.lvl!==r&&(s+=(r-gme.lvl)*Cool.random([1,2,3]),r=gme.lvl),0==h?d.max=2:(o(.05)&&(d.min+=1),o(.1)&&(d.max+=1));let e=.35;if(o(e)&&h>2&&m.max<i.length&&m.max++,h>3){if(o(e)&&z.length>0&&v.push(z.pop()),o(e)&&w.min--,o(e)&&w.max++,o(e)&&p.length>0&&u.push(p.pop()),o(e)&&y.length>0&&g.push(y.pop()),o(e)&&x.length>0&&f.push(x.pop()),o(e)&&c.push(Cool.random(c)*Cool.random([.25,.5,1.5])),o(e)){let e=Cool.random(i.length),t=i.slice(e,e+Cool.random(5));i.push(...t)}o(.5)&&i.length>4&&i.shift()}h++}function P(){n.forEach(e=>e.stop()),Tone.Transport.stop();let e=Cool.randomInt(d.min,d.max);1==h&&(e=2);let t=Cool.random(u),i=Cool.random(c),l=Cool.randomInt(m.min,m.max),a=0==h?0:Cool.random(f);n.push(D(t,i,l,a,I(s)));for(let r=1;r<e;r++){let r=o(.6)||2==e?T(s,Cool.random(v)):I(s);l=Cool.random([l,l+w.min,l-w.max]),t*=Cool.random(g),h>3&&(a=Cool.random([...f,...x]),o(.1)&&(a+="t"),o(.25)&&0!=a&&(a+=".")),i=Cool.random(c),t>8&&(i*=2),n.push(D(t,i,l,a,r))}Tone.Transport.start("+0.1"),A()}function D(e,t,s,i,r){const d=function(){const e=h<3?"U":Cool.random("AEIOU".split("")),t={};for(let s=0;s<a.length;s++){const i=a[s];t[i]=l.get(`${e}-${i}`)}const s=new Tone.Sampler({urls:t,volume:-6}).toDestination(),i=new Tone.Reverb({decay:5}).toDestination();if(s.connect(i),h>8){let e;if(o(.25)){const t=Cool.random(.05,.2);e=new Tone.Distortion(t).toDestination()}else if(o(.25))e=new Tone.Chorus(6,2.5,.5);else if(o(.25)){const t=Cool.random([4,8,12]);e=new Tone.BitCrusher(t).toDestination()}else if(o(.25)){const t=Cool.random(.5,1),s=Cool.random(.1,1);e=new Tone.Tremolo(t,s).toDestination()}e&&s.connect(e)}return s}();let m=s||0,c=Cool.random(C,S),u=1,p=e;e>4&&e<32&&o(.25)&&(u=1/e,p/=2);const g=new Tone.Loop(e=>{if(o(.95)){const e=r[Math.floor(m)%r.length];d.triggerAttackRelease(e,p+"n",void 0,c)}c+=Cool.random(b,M),c.clamp(.1,1),m+=u,m>=r.length*t+s&&(g.stop(),n.every(e=>"stopped"==e.state)&&P())},e+"n").start(i);return g}function I(t){let s=[];for(let o=0;o<i.length;o++)if(null!==i[o]){const l=t+i[o];s.push(e[l])}else s.push(null);return s}function T(s,o){o-=1;let l=[];for(let a=0;a<i.length;a++){const n=i[a];if(null!==n){let i,a=12*Math.floor(Math.abs(n)/12)*(n<0?-1:1);i=n<0?t.indexOf(12-Math.abs(n)%12):t.indexOf(n%12);const h=s+t[(i+o)%t.length]+a;l.push(e[h])}else l.push(null)}return l}this.setBPM=function(e){Tone.Transport.bpm.value=8*e+64},this.play=function(){this.playTheme()},(async()=>{await Tone.start(),function(e){for(let e=2;e<=4;e++)"ABCDEFG".split("").forEach(t=>{a.push(`${t}${e}`)});let t={};for(let e=0;e<a.length;e++)"AEIOU".split("").forEach(s=>{const i=a[e];t[`${s}-${i}`]=`${s}/CH-${s}${s}-${i}.mp3`});console.time("load choir samples"),l=new Tone.ToneAudioBuffers({urls:t,baseUrl:"./audio/choir/",onload:()=>{console.timeEnd("load choir samples"),e()}})}(P)})()}document.addEventListener("keydown",e=>{"Equal"==e.code?mapAlpha=Math.min(1,mapAlpha+.5):"Minus"==e.code&&(mapAlpha=Math.max(0,mapAlpha-.5))}),gme.start=function(){document.getElementById("splash").remove(),map=new HellMap(12),player=new Player(gme.anims.sprites.player,gme.view.halfWidth,gme.view.halfHeight),god=new Sprite(256,gme.view.halfHeight),god.center=!0,god.addAnimation(gme.anims.sprites.god),gme.scenes.add(god,"win","display");const e=new Sprite(gme.view.halfWidth+150,gme.view.halfHeight-100);e.addAnimation(gme.anims.ui.instructions_movement),gme.scenes.instructions.addToDisplay(e),ui=new Scene,ui.metrics={};const t=new UI({x:-150,y:22,animation:gme.anims.ui.hell_icon});ui.addToDisplay(t),ui.metrics.level=new UIMetric(t.x+40,8,()=>gme.lvl.toString());const s=new UI({x:-60,y:22,animation:gme.anims.ui.morality_icon});s.animation.state="neutral",ui.addToDisplay(s),ui.metrics.morality=new UIMetric(s.x+40,4,()=>(0==player.moralityScore?s.animation.state="neutral":player.moralityScore<0?s.animation.state="bad":player.moralityScore>0&&(s.animation.state="good"),player.moralityScore.toString())),ui.console=new Text(leftAlign,4,"",2*grafWrap,gme.anims.lettering.console),ui.addToDisplay(ui.console),ui.console.letters.override.color="#9cf29b",ui.console.xKey=void 0,ui.message=new HellMessage(6,64,"",grafWrap,gme.anims.lettering.messages),ui.message.set(welcomeMessage);const i=new Texture({frame:"randomIndex",animation:gme.anims.ui.border});for(let e=0;e<gme.width;e+=gme.anims.ui.border.width)i.addLocation(e,42);ui.addToDisplay(i);const o=new Text(leftAlign,152,"Welcome to Infinite Hell",grafWrap,gme.anims.lettering.messages);gme.scenes.music.addToDisplay(o);const l=new Text(leftAlign,192,"Press X to start game with sound",grafWrap,gme.anims.lettering.messages);gme.scenes.music.addToDisplay(l);const a=new Text(leftAlign,232,"Press Z to start game silently",grafWrap,gme.anims.lettering.messages);gme.scenes.music.addToDisplay(a),ui.console.xKey=()=>{startMusic(!0)},ui.console.zKey=()=>{startMusic(!1)},gme.scene="music"},gme.update=function(e){player.update(e/gme.dps),gme.scenes.current.update()},gme.draw=function(){gme.scenes.current.display(),player.display(),gme.ctx.fillStyle="#2c2c2c",gme.ctx.fillRect(0,0,gme.view.width,50),ui.display()},gme.keyDown=function(e){switch(e){case"a":case"left":player.inputKey("left",!0);break;case"w":case"up":player.inputKey("up",!0);break;case"d":case"right":player.inputKey("right",!0);break;case"s":case"down":player.inputKey("down",!0);break;case"x":ui.console.xKeyDown=!0;break;case"z":ui.console.zKeyDown=!0}},gme.keyUp=function(e){switch(e){case"a":case"left":player.inputKey("left",!1);break;case"w":case"up":player.inputKey("up",!1);break;case"d":case"right":player.inputKey("right",!1);break;case"s":case"down":player.inputKey("down",!1);break;case"x":if(ui.console.xKeyDown&&ui.console.xKey){const e=ui.console.xKey;ui.console.xKey=void 0,ui.console.setMsg(""),ui.console.xKeyDown=!1,e()}break;case"z":if(ui.console.zKeyDown&&ui.console.zKey){const e=ui.console.zKey;ui.console.zKey=void 0,ui.console.setMsg(""),ui.console.zKeyDown=!1,e()}}};
//# sourceMappingURL=src_maps/hell.min.js.map
